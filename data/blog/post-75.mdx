---
  title: Meta2d.js æºç è§£è¯»åˆ†æ
  publishedAt: 2025-06-16T10:26:50Z
  summary: æŸ¥çœ‹å…¨æ–‡>>
  tags: ["æºç å­¦ä¹ "]
---

# Meta2d.js æºç è§£è¯»åˆ†æ


## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

[Meta2d.js](https://github.com/le5le-com/meta2d.js) æ˜¯ä¸€ä¸ªå®æ—¶æ•°æ®å“åº”å’Œäº¤äº’çš„ 2D å¼•æ“ï¼Œä¸“é—¨ç”¨äº Web ç»„æ€ã€ç‰©è”ç½‘ã€æ•°å­—å­ªç”Ÿç­‰åœºæ™¯ã€‚é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„å¤šåŒ…æ¶æ„è®¾è®¡ï¼Œä½¿ç”¨ pnpm workspaces è¿›è¡ŒåŒ…ç®¡ç†ã€‚

## ğŸ—ï¸ é¡¹ç›®æ•´ä½“æ¶æ„

### 1. å¤šåŒ…ç»“æ„è®¾è®¡

```
packages/
â”œâ”€â”€ core/ # æ ¸å¿ƒå¼•æ“ï¼Œæœ€é‡è¦çš„åŒ… - æ‰€æœ‰åŠŸèƒ½çš„åŸºç¡€
â”œâ”€â”€ meta2d.js/ # ä¸»åŒ…ï¼Œç»Ÿä¸€å¯¼å‡º - ç”¨æˆ·ä¸»è¦ä½¿ç”¨çš„å…¥å£
â”œâ”€â”€ utils/ # å·¥å…·å‡½æ•° - é€šç”¨å·¥å…·å’Œç®—æ³•
â”œâ”€â”€ flow-diagram/ # æµç¨‹å›¾ - ä¸šåŠ¡æµç¨‹å›¾å½¢ç»„ä»¶
â”œâ”€â”€ class-diagram/ # ç±»å›¾ - UMLç±»å›¾ç»„ä»¶
â”œâ”€â”€ sequence-diagram/ # æ—¶åºå›¾ - UMLæ—¶åºå›¾ç»„ä»¶
â”œâ”€â”€ activity-diagram/ # æ´»åŠ¨å›¾ - UMLæ´»åŠ¨å›¾ç»„ä»¶
â”œâ”€â”€ form-diagram/ # è¡¨å•å›¾ - è¡¨å•ç»„ä»¶
â”œâ”€â”€ chart-diagram/ # å›¾è¡¨å›¾ - é›†æˆechartsç­‰å›¾è¡¨åº“
â”œâ”€â”€ fta-diagram/ # æ•…éšœæ ‘åˆ†æå›¾ - ä¸“ä¸šåˆ†æå›¾å½¢
â”œâ”€â”€ le5le-charts/ # å›¾è¡¨ç»„ä»¶ - è‡ªç ”å›¾è¡¨åº“
â”œâ”€â”€ layout/ # å¸ƒå±€ç®—æ³• - è‡ªåŠ¨å¸ƒå±€ç›¸å…³
â”œâ”€â”€ svg/ # SVGæ”¯æŒ - SVGå›¾å½¢å¤„ç†
â””â”€â”€ plugin-mind-/ # æ€ç»´å¯¼å›¾ç›¸å…³æ’ä»¶
```

**æ ¸å¿ƒè®¾è®¡ç†å¿µ:**
- **å•ä¸€èŒè´£**: æ¯ä¸ªåŒ…è´Ÿè´£ç‰¹å®šé¢†åŸŸåŠŸèƒ½
- **æ¾è€¦åˆ**: åŒ…ä¹‹é—´é€šè¿‡æ¥å£äº¤äº’
- **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„å›¾å½¢ç±»å‹å’ŒåŠŸèƒ½

## ğŸ¯ æ ¸å¿ƒå¼•æ“è®¾è®¡ (@meta2d/core)

### 1. ä¸»è¦ç±»ç»“æ„

#### Meta2d ä¸»ç±» (core.ts - 6446è¡Œ)

**èŒè´£**: æ•´ä¸ªå¼•æ“çš„æ ¸å¿ƒæ§åˆ¶å™¨å’Œåè°ƒè€…

```typescript
export class Meta2d {
  store: Meta2dStore;        // å…¨å±€æ•°æ®å­˜å‚¨å’ŒçŠ¶æ€ç®¡ç†
  canvas: Canvas;            // ç”»å¸ƒç®¡ç†å™¨
  websocket: WebSocket;      // WebSocketè¿æ¥
  mqttClient: MqttClient;    // MQTTå®¢æˆ·ç«¯
  events: Record<number, Function>;  // äº‹ä»¶å¤„ç†å™¨æ˜ å°„
  map: ViewMap;              // ç¼©ç•¥å›¾ç®¡ç†
  // ... æ›´å¤šå±æ€§
}
```

**æ ¸å¿ƒåŠŸèƒ½æ¨¡å—:**

1. **æ•°æ®ç®¡ç†å±‚**
   - `store`: ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒå“åº”å¼æ•°æ®ç»‘å®š
   - å†å²è®°å½•ç®¡ç†: æ”¯æŒ undo/redo æ“ä½œ
   - æ•°æ®åºåˆ—åŒ–: æ”¯æŒå®Œæ•´çš„æ•°æ®å¯¼å…¥å¯¼å‡º

2. **æ¸²æŸ“å¼•æ“å±‚**
   - `canvas`: å¤šå±‚ç”»å¸ƒæ¶æ„ï¼Œæ”¯æŒå¤æ‚åœºæ™¯æ¸²æŸ“
   - é«˜æ€§èƒ½ç»˜åˆ¶: è„æ ‡è®°æœºåˆ¶ + è§†å£è£å‰ªä¼˜åŒ–
   - åŠ¨ç”»ç³»ç»Ÿ: æ”¯æŒå¤šç§åŠ¨ç”»ç±»å‹å’Œæ—¶é—´å‡½æ•°

3. **ç½‘ç»œé€šä¿¡å±‚**
   - WebSocket: å®æ—¶åŒå‘æ•°æ®é€šä¿¡
   - MQTT: ç‰©è”ç½‘è®¾å¤‡æ•°æ®æ¥å…¥
   - HTTP: ä¼ ç»Ÿæ•°æ®æ¥å£è°ƒç”¨
   - SSE: æœåŠ¡å™¨æ¨é€äº‹ä»¶

4. **äº‹ä»¶ç³»ç»Ÿ**
   - å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ (onAdd, onDestroy, onValueç­‰)
   - é¼ æ ‡äº¤äº’äº‹ä»¶ (onClick, onMouseEnterç­‰)
   - è‡ªå®šä¹‰ä¸šåŠ¡äº‹ä»¶æ”¯æŒ

#### Pen å›¾å½¢å¯¹è±¡ (pen/model.ts - 844è¡Œ)

**èŒè´£**: æ‰€æœ‰å›¾å½¢å…ƒç´ çš„åŸºç¡€æ•°æ®æ¨¡å‹

```typescript
export interface Pen extends Rect {
  // åŸºç¡€å±æ€§
  id?: string;
  type?: PenType;           // Node(èŠ‚ç‚¹) æˆ– Line(è¿çº¿)
  name?: string;            // å›¾å½¢ç±»å‹åç§°ï¼Œç”¨äºæ¸²æŸ“å™¨é€‰æ‹©
  visible?: boolean;        // å¯è§æ€§æ§åˆ¶
  locked?: LockState;       // é”å®šçŠ¶æ€
  
  // æ ·å¼å±æ€§
  color?: string;           // å‰æ™¯è‰²
  background?: string;      // èƒŒæ™¯è‰²
  lineWidth?: number;       // çº¿å®½
  borderRadius?: number;    // åœ†è§’
  globalAlpha?: number;     // é€æ˜åº¦
  
  // æ–‡æœ¬å±æ€§
  text?: string;
  fontSize?: number;
  fontFamily?: string;
  textAlign?: TextAlign;
  textColor?: string;
  
  // å‡ ä½•å±æ€§
  anchors?: Point[];        // é”šç‚¹å®šä¹‰
  children?: string[];      // å­å…ƒç´ IDåˆ—è¡¨
  connectedLines?: ConnectLine[];  // è¿æ¥çš„çº¿æ¡
  
  // åŠ¨ç”»å±æ€§
  frames?: Pen[];           // å…³é”®å¸§åºåˆ—
  duration?: number;        // åŠ¨ç”»æ—¶é•¿
  animateColor?: string;    // åŠ¨ç”»æ—¶çš„é¢œè‰²
  
  // äº¤äº’å±æ€§
  input?: boolean;          // æ˜¯å¦å¯è¾“å…¥
  dropdownList?: Dropdown[]; // ä¸‹æ‹‰é€‰é¡¹
  events?: Event[];         // äº‹ä»¶é…ç½®
  
  // æ•°æ®ç»‘å®š
  form?: FormItem[];        // è¡¨å•ç»‘å®š
  realTimes?: RealTime[];   // å®æ—¶æ•°æ®é…ç½®
  
  // ç”Ÿå‘½å‘¨æœŸå›è°ƒ
  onAdd?: (pen: Pen) => void;
  onValue?: (pen: Pen) => void;
  onClick?: (pen: Pen, e: Point) => void;
  onDestroy?: (pen: Pen) => void;
  // ... æ›´å¤šå›è°ƒå‡½æ•°
  
  // è®¡ç®—å±æ€§ (ç”¨äºåŠ¨ç”»å’Œæ¸²æŸ“ä¼˜åŒ–)
  calculative?: {
    worldRect?: Rect;       // ä¸–ç•Œåæ ‡ç³»çŸ©å½¢
    worldAnchors?: Point[]; // ä¸–ç•Œåæ ‡ç³»é”šç‚¹
    active?: boolean;       // æ¿€æ´»çŠ¶æ€
    hover?: boolean;        // æ‚¬åœçŠ¶æ€
    // ... å¤§é‡è®¡ç®—ç¼“å­˜å±æ€§
  };
}
```

**æ ¸å¿ƒè®¾è®¡ç†å¿µ:**
- **æ•°æ®é©±åŠ¨**: æ‰€æœ‰å›¾å½¢éƒ½æ˜¯æ•°æ®å¯¹è±¡ï¼Œæ”¯æŒå®Œæ•´åºåˆ—åŒ–
- **å“åº”å¼æ›´æ–°**: æ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘é‡æ¸²æŸ“
- **çŠ¶æ€åˆ†ç¦»**: åŸå§‹æ•°æ®ä¸è®¡ç®—çŠ¶æ€åˆ†ç¦»ï¼Œä¼˜åŒ–æ€§èƒ½
- **æ‰©å±•æ€§å¼º**: æ”¯æŒè‡ªå®šä¹‰å±æ€§å’Œå›è°ƒå‡½æ•°

## ğŸ¨ æ¸²æŸ“ç³»ç»Ÿè®¾è®¡

### å¤šå±‚ç”»å¸ƒæ¶æ„

```typescript
enum CanvasLayer {
  CanvasTemplate = 1,    // æ¨¡æ¿å±‚ - èƒŒæ™¯æ¨¡æ¿å›¾å½¢
  CanvasImageBottom,     // åº•éƒ¨å›¾ç‰‡å±‚ - èƒŒæ™¯å›¾ç‰‡
  CanvasMain,           // ä¸»ç”»å¸ƒå±‚ - ä¸»è¦å›¾å½¢å†…å®¹
  CanvasImage          // é¡¶éƒ¨å›¾ç‰‡å±‚ - å‰æ™¯å›¾ç‰‡
}
```

**åˆ†å±‚æ¸²æŸ“çš„ä¼˜åŠ¿:**
- **æ€§èƒ½ä¼˜åŒ–**: ä¸åŒå±‚ç‹¬ç«‹æ¸²æŸ“ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡ç»˜
- **Z-Indexæ§åˆ¶**: ç²¾ç¡®æ§åˆ¶å›¾å½¢å±‚æ¬¡å…³ç³»
- **åŠŸèƒ½åˆ†ç¦»**: ä¸åŒç±»å‹å†…å®¹åˆ†å±‚ç®¡ç†

### æ¸²æŸ“æµç¨‹ä¼˜åŒ–

```typescript
// æ ¸å¿ƒæ¸²æŸ“æµç¨‹
render(patchFlags?: boolean | number) {
  // 1. è„æ ‡è®°æ£€æŸ¥
  if (!this.needRender()) return;
  
  // 2. è§†å£è£å‰ªè®¡ç®—
  const inViewPens = this.getInViewPens();
  
  // 3. åˆ†å±‚æ¸²æŸ“
  this.renderLayers(inViewPens);
  
  // 4. æ¸…é™¤è„æ ‡è®°
  this.clearPatchFlags();
}
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥:**

1. **è„æ ‡è®°æœºåˆ¶** (`patchFlags`)
   - åªé‡ç»˜éœ€è¦æ›´æ–°çš„éƒ¨åˆ†
   - æ”¯æŒç»†ç²’åº¦çš„æ›´æ–°æ§åˆ¶

2. **è§†å£è£å‰ª** (`calcInView`)
   - åªæ¸²æŸ“å¯è§åŒºåŸŸå†…çš„å›¾å½¢
   - å¤§å¹…æå‡å¤§æ•°æ®é‡åœºæ™¯æ€§èƒ½

3. **ç¦»å±æ¸²æŸ“**
   - å¤æ‚å›¾å½¢é¢„æ¸²æŸ“åˆ°ç¦»å±ç”»å¸ƒ
   - ç¼“å­˜é™æ€å†…å®¹ï¼Œå‡å°‘é‡å¤è®¡ç®—

4. **æ‰¹é‡æ“ä½œ**
   - å¤šä¸ªä¿®æ”¹æ“ä½œåˆå¹¶ä¸ºä¸€æ¬¡æ¸²æŸ“
   - å‡å°‘æ¸²æŸ“è°ƒç”¨æ¬¡æ•°

## ğŸš€ é«˜æ€§èƒ½æ¶æ„è®¾è®¡

### 1. æ•°æ®ç»“æ„ä¼˜åŒ–

```typescript
// è®¡ç®—å±æ€§ç¼“å­˜æœºåˆ¶
calculative?: {
  // ä¸–ç•Œåæ ‡ç³»ç¼“å­˜ - é¿å…é‡å¤è®¡ç®—
  worldRect?: Rect;
  worldAnchors?: Point[];
  worldTextRect?: Rect;
  
  // æ–‡æœ¬å¸ƒå±€ç¼“å­˜ - æ–‡æœ¬æµ‹é‡å¼€é”€å¤§
  textLines?: string[];
  textLineWidths?: number[];
  
  // æ¸²æŸ“çŠ¶æ€ç¼“å­˜ - å‡å°‘çŠ¶æ€è®¡ç®—
  active?: boolean;
  hover?: boolean;
  visible?: boolean;
  
  // å›¾ç‰‡èµ„æºç¼“å­˜ - é¿å…é‡å¤åŠ è½½
  img?: HTMLImageElement;
  backgroundImg?: HTMLImageElement;
}
```

### 2. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

**è§†å£ç®¡ç†:**
```typescript
// åªæ¸²æŸ“å¯è§åŒºåŸŸ
calcInView(pen: Pen, store: Meta2dStore): boolean {
  if (!pen.calculative.worldRect) return false;
  
  return rectInRect(
    pen.calculative.worldRect,
    store.viewRect
  );
}
```

**åˆ†å—æ¸²æŸ“:**
- å¤§åœºæ™¯è‡ªåŠ¨åˆ†å—å¤„ç†
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨æœºåˆ¶
- åŠ¨æ€åŠ è½½å¯è§å†…å®¹

### 3. å†…å­˜ç®¡ç†ç­–ç•¥

```typescript
// èµ„æºæ¸…ç†æœºåˆ¶
destroy(onlyData?: boolean) {
  // æ¸…ç†ç”»å¸ƒèµ„æº
  this.canvas.destroy();
  
  // æ–­å¼€ç½‘ç»œè¿æ¥
  this.closeWebsocket();
  this.closeMqtt();
  
  // æ¸…ç†äº‹ä»¶ç›‘å¬
  this.store.emitter.all.clear();
  
  // æ¸…ç†å®šæ—¶å™¨
  clearInterval(this.animateTimer);
}
```

## ğŸ“¡ æ•°æ®é€šä¿¡æ¶æ„

### å®æ—¶æ•°æ®é€šä¿¡æ”¯æŒ

```typescript
// å¤šåè®®æ”¯æŒ
class Meta2d {
  // WebSocket è¿æ¥
  async connectWebsocket(url?: string) {
    this.websocket = new WebSocket(url);
    this.websocket.onmessage = this.socketCallback;
  }
  
  // MQTT è¿æ¥  
  async connectMqtt(params: MqttParams) {
    this.mqttClient = mqtt.connect(params.mqtt, params.options);
    this.mqttClient.on('message', this.socketCallback);
  }
  
  // HTTP è½®è¯¢
  async connectHttp() {
    setInterval(() => {
      this.requestHttp(this.store.data.https);
    }, this.store.data.interval);
  }
  
  // Server-Sent Events
  connectSSE(net: Network) {
    const eventSource = new EventSource(net.url);
    eventSource.onmessage = this.socketCallback;
  }
}
```

### æ•°æ®ç»‘å®šæœºåˆ¶

```typescript
// æ•°æ®æ›´æ–°API
interface IValue {
  id?: string;           // å›¾å½¢ID
  dataId?: string;       // æ•°æ®ID  
  value: any;           // æ–°å€¼
  [key: string]: any;   // å…¶ä»–å±æ€§
}

// å•ä¸ªæ•°æ®æ›´æ–°
setValue(data: IValue, options?: {
  render?: boolean;     // æ˜¯å¦é‡æ¸²æŸ“
  doEvent?: boolean;    // æ˜¯å¦è§¦å‘äº‹ä»¶
  history?: boolean;    // æ˜¯å¦è®°å½•å†å²
}) {
  // æ•°æ®éªŒè¯å’Œè½¬æ¢
  const pen = this.findPen(data.id);
  
  // æ›´æ–°å›¾å½¢å±æ€§
  Object.assign(pen, data);
  
  // è§¦å‘é‡æ¸²æŸ“
  if (options.render) {
    this.render();
  }
  
  // è§¦å‘æ•°æ®äº‹ä»¶
  if (options.doEvent) {
    pen.onValue?.(pen);
  }
}

// æ‰¹é‡æ•°æ®æ›´æ–°
setDatas(datas: IValue[], options?) {
  // æ‰¹é‡å¤„ç†ï¼Œæœ€åç»Ÿä¸€æ¸²æŸ“
  datas.forEach(data => {
    this.setValue(data, { ...options, render: false });
  });
  
  if (options.render !== false) {
    this.render();
  }
}
```

## ğŸª åŠ¨ç”»ç³»ç»Ÿæ¶æ„

### åŠ¨ç”»ç±»å‹æ”¯æŒ

```typescript
enum LineAnimateType {
  Normal,      // æ°´æµæ•ˆæœ
  Beads,       // æ°´ç æµåŠ¨  
  Dot,         // åœ†ç‚¹åŠ¨ç”»
  Arrow,       // ç®­å¤´åŠ¨ç”»
  WaterDrop,   // æ°´æ»´æ•ˆæœ
  Custom       // è‡ªå®šä¹‰åŠ¨ç”»
}

// åŠ¨ç”»é…ç½®
interface AnimationConfig {
  duration?: number;           // åŠ¨ç”»æ—¶é•¿
  linear?: boolean;           // æ˜¯å¦åŒ€é€Ÿ
  animateCycle?: number;      // å¾ªç¯æ¬¡æ•°
  animateReverse?: boolean;   // æ˜¯å¦åå‘
  animateTimingFunction?: string; // æ—¶é—´å‡½æ•°
  keepAnimateState?: boolean; // ä¿æŒç»“æŸçŠ¶æ€
}
```

### åŠ¨ç”»è°ƒåº¦ç³»ç»Ÿ

```typescript
// é«˜æ€§èƒ½åŠ¨ç”»å¾ªç¯
private animate = () => {
  const now = performance.now();
  
  // éå†æ‰€æœ‰åŠ¨ç”»å¯¹è±¡
  this.store.animates.forEach(pen => {
    if (pen.calculative.pause) return;
    
    // è®¡ç®—åŠ¨ç”»è¿›åº¦
    const progress = this.calcAnimateProgress(pen, now);
    
    // åº”ç”¨åŠ¨ç”»æ•ˆæœ
    this.applyAnimateFrame(pen, progress);
  });
  
  // è¯·æ±‚ä¸‹ä¸€å¸§
  requestAnimationFrame(this.animate);
};

// åŠ¨ç”»æ—¶é—´å‡½æ•°æ”¯æŒ
calcAnimateProgress(pen: Pen, now: number): number {
  const { start, duration, animateTimingFunction } = pen.calculative;
  let progress = (now - start) / duration;
  
  // åº”ç”¨ç¼“åŠ¨å‡½æ•°
  if (animateTimingFunction) {
    progress = this.applyEasing(progress, animateTimingFunction);
  }
  
  return Math.min(progress, 1);
}
```

## ğŸ”§ æ‰©å±•æœºåˆ¶è®¾è®¡

### 1. å›¾å½¢åº“æ³¨å†Œç³»ç»Ÿ

```typescript
// æ³¨å†Œè‡ªå®šä¹‰å›¾å½¢
register(penMap: Record<string, Function>) {
  Object.entries(penMap).forEach(([name, drawFn]) => {
    globalStore.penDraw[name] = drawFn;
  });
}

// ä½¿ç”¨ç¤ºä¾‹
meta2d.register({
  myCustomShape: (pen: Pen, ctx: CanvasRenderingContext2D) => {
    // è‡ªå®šä¹‰ç»˜åˆ¶é€»è¾‘
    ctx.beginPath();
    ctx.arc(pen.x, pen.y, pen.width/2, 0, Math.PI * 2);
    ctx.fill();
  }
});
```

### 2. æ’ä»¶ç³»ç»Ÿæ¶æ„

```typescript
interface PenPlugin {
  name: string;
  install: (pen: Pen | string, options: any) => void;
  uninstall: (pen: Pen | string, options: any) => void;
  [key: string]: any;
}

// æ’ä»¶ç®¡ç†
installPenPlugins(pen: PenSelector, plugins: PluginOptions[]) {
  plugins.forEach(({ plugin, options, enable = true }) => {
    if (enable) {
      plugin.install(pen, options);
      this.trackPlugin(pen, plugin, options);
    }
  });
}
```

### 3. äº‹ä»¶æ‰©å±•æœºåˆ¶

```typescript
// ä¸°å¯Œçš„äº‹ä»¶å›è°ƒæ”¯æŒ
interface PenEvents {
  // ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
  onAdd?: (pen: Pen) => void;
  onDestroy?: (pen: Pen) => void;
  onValue?: (pen: Pen) => void;
  
  // äº¤äº’äº‹ä»¶  
  onClick?: (pen: Pen, e: Point) => void;
  onMouseEnter?: (pen: Pen, e: Point) => void;
  onMouseLeave?: (pen: Pen, e: Point) => void;
  
  // ç¼–è¾‘äº‹ä»¶
  onMove?: (pen: Pen) => void;
  onResize?: (pen: Pen) => void;
  onRotate?: (pen: Pen) => void;
  
  // æ•°æ®äº‹ä»¶
  onBeforeValue?: (pen: Pen, value: any) => any;
  onBinds?: (pen: Pen, values: IValue[], formItem: FormItem) => IValue;
  
  // åª’ä½“äº‹ä»¶
  onStartVideo?: (pen: Pen) => void;
  onPauseVideo?: (pen: Pen) => void;
}
```

## ğŸ’¡ æ ¸å¿ƒè®¾è®¡æ¨¡å¼åº”ç”¨

### 1. è§‚å¯Ÿè€…æ¨¡å¼ (äº‹ä»¶ç³»ç»Ÿ)

```typescript
// åŸºäº mitt åº“çš„äº‹ä»¶æ€»çº¿
import mitt from 'mitt';

class Meta2dStore {
  emitter = mitt();
  
  // è§¦å‘äº‹ä»¶
  emit(type: string, data: any) {
    this.emitter.emit(type, data);
  }
  
  // ç›‘å¬äº‹ä»¶
  on(type: string, handler: Function) {
    this.emitter.on(type, handler);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
store.on('valueChanged', (data) => {
  // å“åº”æ•°æ®å˜åŒ–
  this.updateRelatedPens(data);
});
```

### 2. ç­–ç•¥æ¨¡å¼ (æ¸²æŸ“ç­–ç•¥)

```typescript
// ä¸åŒå›¾å½¢ç±»å‹ä½¿ç”¨ä¸åŒæ¸²æŸ“ç­–ç•¥
const penDrawMap: Record<string, DrawFunction> = {
  rectangle: drawRect,
  circle: drawCircle,
  line: drawLine,
  curve: drawCurve,
  // ... æ›´å¤šå›¾å½¢ç±»å‹
};

function renderPen(pen: Pen, ctx: CanvasRenderingContext2D) {
  const drawFn = penDrawMap[pen.name];
  if (drawFn) {
    drawFn(pen, ctx);
  }
}
```

### 3. å‘½ä»¤æ¨¡å¼ (å†å²è®°å½•)

```typescript
interface EditAction {
  type: EditType;
  pens?: Pen[];
  oldPens?: Pen[];
  // ... å…¶ä»–æ“ä½œæ•°æ®
}

class HistoryManager {
  private history: EditAction[] = [];
  private index = -1;
  
  // æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•
  execute(action: EditAction) {
    this.doAction(action);
    this.history.splice(++this.index, 0, action);
  }
  
  // æ’¤é”€
  undo() {
    if (this.index >= 0) {
      const action = this.history[this.index--];
      this.undoAction(action);
    }
  }
  
  // é‡åš  
  redo() {
    if (this.index < this.history.length - 1) {
      const action = this.history[++this.index];
      this.doAction(action);
    }
  }
}
```

### 4. å·¥å‚æ¨¡å¼ (å¯¹è±¡åˆ›å»º)

```typescript
// å›¾å½¢å¯¹è±¡å·¥å‚
class PenFactory {
  static create(type: string, options: Partial<Pen>): Pen {
    const basePen: Pen = {
      id: generateId(),
      type: PenType.Node,
      x: 0, y: 0, width: 100, height: 100,
      ...options
    };
    
    // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤å±æ€§
    switch (type) {
      case 'rectangle':
        return { ...basePen, name: 'rectangle' };
      case 'circle':  
        return { ...basePen, name: 'circle', borderRadius: 50 };
      case 'line':
        return { ...basePen, type: PenType.Line, name: 'line' };
      default:
        return basePen;
    }
  }
}
```

## ğŸ¯ å¼€å‘å®è·µæŒ‡å—

### 1. æ·»åŠ æ–°å›¾å½¢ç±»å‹

```typescript
// 1. å®šä¹‰ç»˜åˆ¶å‡½æ•°
function drawCustomShape(pen: Pen, ctx: CanvasRenderingContext2D) {
  // å®ç°è‡ªå®šä¹‰ç»˜åˆ¶é€»è¾‘
  ctx.save();
  
  // è®¾ç½®æ ·å¼
  ctx.fillStyle = pen.background || '#000';
  ctx.strokeStyle = pen.color || '#000';
  ctx.lineWidth = pen.lineWidth || 1;
  
  // ç»˜åˆ¶å›¾å½¢
  ctx.beginPath();
  // ... å…·ä½“ç»˜åˆ¶ä»£ç 
  ctx.fill();
  ctx.stroke();
  
  ctx.restore();
}

// 2. æ³¨å†Œå›¾å½¢
meta2d.register({
  customShape: drawCustomShape
});

// 3. ä½¿ç”¨å›¾å½¢
meta2d.addPen({
  name: 'customShape',
  x: 100, y: 100,
  width: 200, height: 100
});
```

### 2. æ‰©å±•å›¾å½¢å±æ€§

```typescript
// 1. æ‰©å±• Pen æ¥å£ (é€šè¿‡æ¨¡å—æ‰©å±•)
declare module '@meta2d/core' {
  interface Pen {
    customProperty?: string;
    customConfig?: {
      option1: number;
      option2: boolean;
    };
  }
}

// 2. åœ¨ç»˜åˆ¶å‡½æ•°ä¸­ä½¿ç”¨
function drawEnhancedShape(pen: Pen, ctx: CanvasRenderingContext2D) {
  // ä½¿ç”¨è‡ªå®šä¹‰å±æ€§
  if (pen.customProperty) {
    // æ ¹æ®è‡ªå®šä¹‰å±æ€§è°ƒæ•´ç»˜åˆ¶
  }
}
```

### 3. å®ç°è‡ªå®šä¹‰åŠ¨ç”»

```typescript
// 1. å®šä¹‰åŠ¨ç”»å¸§
const animationFrames: Pen[] = [
  { x: 0, y: 0, scale: 1 },
  { x: 100, y: 50, scale: 1.2 },
  { x: 200, y: 0, scale: 1 }
];

// 2. åº”ç”¨åŠ¨ç”»
meta2d.addPen({
  name: 'rectangle',
  frames: animationFrames,
  duration: 2000,
  animateCycle: 0, // æ— é™å¾ªç¯
  autoPlay: true
});
```

### 4. æ·»åŠ æ•°æ®é€šä¿¡

```typescript
// 1. é…ç½®æ•°æ®æº
meta2d.addPen({
  name: 'gauge',
  id: 'pressure-gauge',
  // ç»‘å®šå®æ—¶æ•°æ®
  realTimes: [{
    key: 'value',
    dataId: 'pressure.current'
  }]
});

// 2. å»ºç«‹è¿æ¥
meta2d.connectWebsocket('ws://localhost:8080');

// 3. å¤„ç†æ•°æ®æ›´æ–°
meta2d.on('valueChanged', (data) => {
  console.log('æ•°æ®æ›´æ–°:', data);
});
```

## ğŸ” æ€§èƒ½ç›‘æ§å’Œè°ƒè¯•

### 1. æ€§èƒ½æŒ‡æ ‡

```typescript
// æ€§èƒ½ç»Ÿè®¡
statistics() {
  return {
    totalPens: this.store.data.pens.length,
    activePens: this.store.active.length,
    animatingPens: this.store.animates.length,
    renderTime: this.store.renderTime,
    fps: this.store.fps
  };
}
```

### 2. è°ƒè¯•å·¥å…·

```typescript
// å¼€å‘æ¨¡å¼è°ƒè¯•
if (process.env.NODE_ENV === 'development') {
  // æ˜¾ç¤ºæ€§èƒ½ä¿¡æ¯
  meta2d.showStats = true;
  
  // æ˜¾ç¤ºé”šç‚¹
  meta2d.showAnchor = true;
  
  // æ˜¾ç¤ºè¾¹ç•Œæ¡†
  meta2d.showBounds = true;
}
```

## ğŸ“š å¸¸è§é—®é¢˜è§£å†³

### 1. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **å¤§æ•°æ®é‡åœºæ™¯**: ä½¿ç”¨ `visible` å±æ€§æ§åˆ¶æ˜¾ç¤ºï¼Œå¯ç”¨è§†å£è£å‰ª
- **å¤æ‚åŠ¨ç”»**: ä½¿ç”¨ç¦»å±æ¸²æŸ“ï¼Œå‡å°‘ä¸»ç”»å¸ƒé‡ç»˜
- **é¢‘ç¹æ•°æ®æ›´æ–°**: ä½¿ç”¨æ‰¹é‡æ›´æ–°APIï¼Œé¿å…é¢‘ç¹å•ä¸ªæ›´æ–°

### 2. å†…å­˜ç®¡ç†

- **åŠæ—¶æ¸…ç†**: ä¸ç”¨çš„å›¾å½¢è°ƒç”¨ `delete()` æ–¹æ³•æ¸…ç†
- **èµ„æºå¤ç”¨**: ç›¸åŒå›¾ç‰‡ä½¿ç”¨ç›¸åŒURLï¼Œåˆ©ç”¨æµè§ˆå™¨ç¼“å­˜
- **äº‹ä»¶æ¸…ç†**: ç»„ä»¶é”€æ¯æ—¶è®°å¾—æ¸…ç†äº‹ä»¶ç›‘å¬

### 3. æ‰©å±•å¼€å‘

- **å›¾å½¢åº“**: å»ºè®®åˆ›å»ºç‹¬ç«‹çš„åŒ…è¿›è¡Œç®¡ç†
- **æ’ä»¶ç³»ç»Ÿ**: åˆ©ç”¨ç°æœ‰æ’ä»¶æœºåˆ¶ï¼Œé¿å…ä¿®æ”¹æ ¸å¿ƒä»£ç 
- **ä¸»é¢˜ç³»ç»Ÿ**: é€šè¿‡ `setTheme` å®ç°æ ·å¼ç»Ÿä¸€ç®¡ç†

## ğŸ–ï¸ æ€»ç»“

Meta2d.js æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯çš„ç°ä»£åŒ– 2D å›¾å½¢å¼•æ“ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

**æŠ€æœ¯ä¼˜åŠ¿:**
- ğŸš€ **é«˜æ€§èƒ½**: å¤šå±‚æ¸²æŸ“ + è„æ ‡è®° + è§†å£è£å‰ª
- ğŸ”Œ **é«˜æ‰©å±•**: æ’ä»¶ç³»ç»Ÿ + äº‹ä»¶æœºåˆ¶ + å›¾å½¢æ³¨å†Œ
- ğŸ“¡ **å®æ—¶æ•°æ®**: å¤šåè®®æ”¯æŒ + å“åº”å¼æ›´æ–°  
- ğŸ¨ **ä¸°å¯ŒåŠŸèƒ½**: åŠ¨ç”»ç³»ç»Ÿ + ä¸»é¢˜ç³»ç»Ÿ + å¸ƒå±€ç®—æ³•

**æ¶æ„ä¼˜åŠ¿:**
- ğŸ“¦ **æ¨¡å—åŒ–**: å¤šåŒ…æ¶æ„ï¼ŒèŒè´£æ¸…æ™°
- ğŸ—ï¸ **å¯ç»´æŠ¤**: è®¾è®¡æ¨¡å¼åº”ç”¨ï¼Œä»£ç ç»“æ„è‰¯å¥½
- ğŸ”§ **æ˜“ç”¨æ€§**: ä¸°å¯Œçš„APIï¼Œå®Œå–„çš„ç±»å‹å®šä¹‰
- ğŸŒ **ç”Ÿæ€**: å¼€æºï¼Œæ”¯æŒå¤šç§å›¾è¡¨åº“é›†æˆ

---

*ä»…ä¾›å‚è€ƒ*

---
æœ¬äººè‡ªåŠ¨å‘å¸ƒäºï¼š[https://github.com/giscafer/blog/issues/75](https://github.com/giscafer/blog/issues/75)
